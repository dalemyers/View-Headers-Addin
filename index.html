<html>
    <head>
        <meta charset="UTF-8">    
        <title>View Headers</title>
        <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" type="text/javascript"></script>
    </head>
    <body>
        <p id="headers" style="font-family:Monospaced"></p>

        <script>

            Office.initialize = function (reason) {
                $(document).ready(function () {
                    sendHeadersRequest();
                });
            }

            
function getSoapEnvelope(request) {
    // Wrap an Exchange Web Services request in a SOAP envelope.
    var result =
    "<?xml version='1.0' encoding='utf-8'?>" +
    "<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'" +
    "               xmlns:m='http://schemas.microsoft.com/exchange/services/2006/messages'" +
    "               xmlns:xsd='http://www.w3.org/2001/XMLSchema'" +
    "               xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'" +
    "               xmlns:t='http://schemas.microsoft.com/exchange/services/2006/types'>" +
    "  <soap:Header>" +
    "     <t:RequestServerVersion Version='Exchange2013'/>" +
    "  </soap:Header>" +
    "  <soap:Body>" +
    request +
    "  </soap:Body>" +
    "</soap:Envelope>";

    return result;
}

function getHeadersRequest(id) {
    // Return a GetItem EWS operation request for the headers of the specified item.
    var result =
    "    <GetItem xmlns='http://schemas.microsoft.com/exchange/services/2006/messages'>" +
    "      <ItemShape>" +
    "        <t:BaseShape>IdOnly</t:BaseShape>" +
    "        <t:BodyType>Text</t:BodyType>" +
    "        <t:AdditionalProperties>" +
    "            <t:ExtendedFieldURI PropertyTag='0x007D' PropertyType='String' />" +
    "            <t:ExtendedFieldURI PropertyTag='0x0E05' PropertyType='String' />" +
    "            <t:FieldURI FieldURI='item:HasAttachments' />" +
    "        </t:AdditionalProperties>" +
    "      </ItemShape>" +
    "      <ItemIds><t:ItemId Id='" + id + "'/></ItemIds>" +
    "    </GetItem>";

    return result;
}


function sendHeadersRequest() {

    var mailbox = Office.context.mailbox;
    var request = getHeadersRequest(mailbox.item.itemId);
    var envelope = getSoapEnvelope(request);

    try {
        mailbox.makeEwsRequestAsync(envelope, headerCallback);
    } catch (e) {
        document.getElementById("headers").innerHTML = "Failed to get headers...";
    }
}

function displayHeaders(headers) {
    document.getElementById("headers").innerHTML = headers;
}

function displayError(errorText) {
    document.getElementById("headers").innerHTML = errorText;
}

// Function called when the EWS request is complete.
function headerCallback(asyncResult) {

    var originalHeaders = "";

    if (!asyncResult.value)
    {
        displayError(asyncResult.error);
        return;
    }

        var prop = null;
        try {
            var response = $.parseXML(asyncResult.value);
            var responseDOM = $(response);

            if (responseDOM) {

                responseDOM.find("t\\:ExtendedProperty").each(function (i, j) {
                    var propertyTag = $(j).find("t\\:ExtendedFieldURI").attr("PropertyTag");
                    var textContent = j.textContent;

                    if (propertyTag == '0x7d') {
                        originalHeaders = textContent;
                    } 
                });

                // Chrome, doesn't like the namespace in find method, so lets try again without the namespace
                if (originalHeaders.length == 0) {
                    responseDOM.find("ExtendedProperty").each(function (i, j) {
                        var propertyTag = $(j).find("ExtendedFieldURI").attr("PropertyTag");
                        var textContent = j.textContent;

                        if (propertyTag == '0x7d') {
                            viewModel.originalHeaders = textContent;
                        }
                    });
                }

            }
        } catch (e) {
        }

        if (originalHeaders.length > 0) {
            displayHeaders(originalHeaders);
        } else {
            displayError("The email didn't have any headers.");
        }
}

        </script>
    </body>
</html>
